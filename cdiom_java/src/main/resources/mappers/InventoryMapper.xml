<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cdiom.backend.mapper.InventoryMapper">

    <!-- 库存汇总统计 -->
    <select id="selectInventorySummary" resultType="map">
        SELECT
            d.drug_name,
            d.drug_code,
            SUM(i.quantity) as total_quantity,
            COUNT(DISTINCT i.batch_number) as batch_count,
            MIN(i.expiry_date) as earliest_expiry,
            AVG(i.quantity) as avg_quantity
        FROM inventory i
        LEFT JOIN drug_info d ON i.drug_id = d.id
        WHERE i.status = 1
        GROUP BY i.drug_id, d.drug_name, d.drug_code
        ORDER BY total_quantity DESC
    </select>

    <!-- 查询库存变动记录（模拟，需要扩展表结构） -->
    <select id="selectInventoryChanges" resultType="map">
        SELECT
            i.drug_id,
            d.drug_name,
            d.drug_code,
            i.batch_number,
            i.quantity as current_quantity,
            i.location,
            i.create_time
        FROM inventory i
        LEFT JOIN drug_info d ON i.drug_id = d.id
        WHERE i.status = 1
        <if test="drugId != null">
            AND i.drug_id = #{drugId}
        </if>
        <if test="startDate != null">
            AND i.create_time >= #{startDate}
        </if>
        <if test="endDate != null">
            AND i.create_time <= #{endDate}
        </if>
        ORDER BY i.create_time DESC
    </select>

    <!-- 库存盘点查询 -->
    <select id="selectInventoryCheck" resultType="map">
        SELECT
            i.*,
            d.drug_name,
            d.drug_code,
            d.unit,
            d.category,
            CASE
                WHEN i.quantity <= i.warning_quantity THEN '预警'
                WHEN i.expiry_date <= DATE_ADD(CURDATE(), INTERVAL 30 DAY) THEN '临近过期'
                WHEN i.expiry_date < CURDATE() THEN '已过期'
                ELSE '正常'
            END as status_desc
        FROM inventory i
        LEFT JOIN drug_info d ON i.drug_id = d.id
        WHERE i.status = 1
        ORDER BY i.location, d.drug_name
    </select>

</mapper>