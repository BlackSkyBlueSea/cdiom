<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cdiom.backend.mapper.OutboundApplyMapper">

    <!-- 查询申领单详情（包含申领明细） -->
    <select id="selectApplyDetail" resultType="map">
        SELECT
            oa.*,
            u1.real_name as applicant_name,
            u2.real_name as approver_name,
            oai.drug_id,
            d.drug_name,
            d.drug_code,
            d.unit,
            oai.apply_quantity,
            oai.approved_quantity,
            oai.actual_quantity,
            oai.batch_number
        FROM outbound_apply oa
        LEFT JOIN sys_user u1 ON oa.applicant_id = u1.id
        LEFT JOIN sys_user u2 ON oa.approver_id = u2.id
        LEFT JOIN outbound_apply_item oai ON oa.id = oai.apply_id
        LEFT JOIN drug_info d ON oai.drug_id = d.id
        WHERE oa.id = #{applyId}
        ORDER BY oai.create_time
    </select>

    <!-- 出库申领统计 -->
    <select id="selectOutboundStatistics" resultType="map">
        SELECT
            DATE_FORMAT(apply_date, '%Y-%m') as month,
            COUNT(*) as apply_count,
            SUM(total_quantity) as total_quantity,
            COUNT(CASE WHEN status = 'APPROVED' THEN 1 END) as approved_count,
            COUNT(CASE WHEN status = 'COMPLETED' THEN 1 END) as completed_count
        FROM outbound_apply
        <if test="startDate != null">
            WHERE apply_date >= #{startDate}
        </if>
        <if test="endDate != null">
            AND apply_date <= #{endDate}
        </if>
        GROUP BY DATE_FORMAT(apply_date, '%Y-%m')
        ORDER BY month DESC
    </select>

    <!-- 部门申领统计 -->
    <select id="selectDepartmentStatistics" resultType="map">
        SELECT
            department,
            COUNT(*) as apply_count,
            SUM(total_quantity) as total_quantity,
            AVG(total_quantity) as avg_quantity
        FROM outbound_apply
        WHERE department IS NOT NULL AND department != ''
        GROUP BY department
        ORDER BY total_quantity DESC
    </select>

    <!-- 批量审批申领单 -->
    <update id="batchApprove">
        UPDATE outbound_apply
        SET status = 'APPROVED',
            approver_id = #{approverId},
            approval_time = NOW(),
            approval_opinion = #{approvalOpinion},
            update_time = NOW()
        WHERE id IN
        <foreach item="id" collection="ids" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 批量拒绝申领单 -->
    <update id="batchReject">
        UPDATE outbound_apply
        SET status = 'REJECTED',
            approver_id = #{approverId},
            approval_time = NOW(),
            approval_opinion = #{approvalOpinion},
            update_time = NOW()
        WHERE id IN
        <foreach item="id" collection="ids" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

</mapper>
