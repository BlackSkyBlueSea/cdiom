<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cdiom.backend.mapper.PurchaseOrderMapper">

    <!-- 查询订单详情（包含订单明细） -->
    <select id="selectOrderDetail" resultType="map">
        SELECT
            po.*,
            u.real_name as approver_name,
            poi.drug_id,
            d.drug_name,
            d.drug_code,
            d.unit,
            poi.quantity as order_quantity,
            poi.unit_price,
            poi.total_amount as item_total,
            poi.batch_number
        FROM purchase_order po
        LEFT JOIN sys_user u ON po.approver_id = u.id
        LEFT JOIN purchase_order_item poi ON po.id = poi.order_id
        LEFT JOIN drug_info d ON poi.drug_id = d.id
        WHERE po.id = #{orderId}
        ORDER BY poi.create_time
    </select>

    <!-- 采购订单统计 -->
    <select id="selectPurchaseStatistics" resultType="map">
        SELECT
            DATE_FORMAT(order_date, '%Y-%m') as month,
            COUNT(*) as order_count,
            SUM(total_amount) as total_amount,
            AVG(total_amount) as avg_amount
        FROM purchase_order
        WHERE status != 'CANCELLED'
        <if test="startDate != null">
            AND order_date >= #{startDate}
        </if>
        <if test="endDate != null">
            AND order_date <= #{endDate}
        </if>
        GROUP BY DATE_FORMAT(order_date, '%Y-%m')
        ORDER BY month DESC
    </select>

    <!-- 供应商采购统计 -->
    <select id="selectSupplierStatistics" resultType="map">
        SELECT
            supplier,
            COUNT(*) as order_count,
            SUM(total_amount) as total_amount,
            AVG(total_amount) as avg_amount,
            MAX(order_date) as last_order_date
        FROM purchase_order
        WHERE status != 'CANCELLED'
        GROUP BY supplier
        ORDER BY total_amount DESC
    </select>

    <!-- 批量更新订单状态 -->
    <update id="batchUpdateStatus">
        UPDATE purchase_order
        SET status = #{status},
            approver_id = #{approverId},
            approval_time = NOW(),
            update_time = NOW()
        WHERE id IN
        <foreach item="id" collection="ids" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

</mapper>
