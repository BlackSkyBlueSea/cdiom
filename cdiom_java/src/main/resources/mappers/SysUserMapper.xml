<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cdiom.backend.mapper.SysUserMapper">

    <!-- 根据用户名或手机号查询用户（包含角色信息） -->
    <select id="selectByUsernameOrPhone" resultType="com.cdiom.backend.model.SysUser">
        SELECT
            u.id,
            u.username,
            u.phone,
            u.password,
            u.role_id as roleId,
            u.status,
            u.lock_time as lockTime,
            u.login_fail_count as loginFailCount,
            u.create_by as createBy,
            u.create_time as createTime,
            u.update_time as updateTime,
            u.deleted
        FROM sys_user u
        WHERE u.deleted = 0
          AND (u.username = #{usernameOrPhone} OR u.phone = #{usernameOrPhone})
        LIMIT 1
    </select>

    <!-- 分页查询用户列表（包含角色信息） -->
    <select id="selectUserList" resultType="com.cdiom.backend.common.UserDTO">
        SELECT
            u.id,
            u.username,
            u.phone,
            u.role_id as roleId,
            r.role_name as roleName,
            r.role_desc as roleDesc,
            u.status,
            CASE u.status
                WHEN 0 THEN '禁用'
                WHEN 1 THEN '正常'
                ELSE '未知'
            END as statusText,
            u.lock_time as lockTime,
            CASE
                WHEN u.lock_time IS NOT NULL AND TIMESTAMPDIFF(HOUR, u.lock_time, NOW()) &lt; 1 THEN 1
                ELSE 0
            END as isLocked,
            u.login_fail_count as loginFailCount,
            u.create_by as createBy,
            creator.username as createByName,
            u.create_time as createTime,
            u.update_time as updateTime
        FROM sys_user u
        LEFT JOIN sys_role r ON u.role_id = r.id
        LEFT JOIN sys_user creator ON u.create_by = creator.id
        WHERE u.deleted = 0
        <if test="keyword != null and keyword != ''">
            AND (u.username LIKE CONCAT('%', #{keyword}, '%')
                 OR u.phone LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <if test="roleId != null">
            AND u.role_id = #{roleId}
        </if>
        <if test="status != null">
            AND u.status = #{status}
        </if>
        ORDER BY u.create_time DESC
    </select>

    <!-- 根据ID查询用户详情（包含角色信息） -->
    <select id="selectUserById" resultType="com.cdiom.backend.common.UserDTO">
        SELECT
            u.id,
            u.username,
            u.phone,
            u.role_id as roleId,
            r.role_name as roleName,
            r.role_desc as roleDesc,
            u.status,
            CASE u.status
                WHEN 0 THEN '禁用'
                WHEN 1 THEN '正常'
                ELSE '未知'
            END as statusText,
            u.lock_time as lockTime,
            CASE
                WHEN u.lock_time IS NOT NULL AND TIMESTAMPDIFF(HOUR, u.lock_time, NOW()) &lt; 1 THEN 1
                ELSE 0
            END as isLocked,
            u.login_fail_count as loginFailCount,
            u.create_by as createBy,
            creator.username as createByName,
            u.create_time as createTime,
            u.update_time as updateTime
        FROM sys_user u
        LEFT JOIN sys_role r ON u.role_id = r.id
        LEFT JOIN sys_user creator ON u.create_by = creator.id
        WHERE u.deleted = 0 AND u.id = #{userId}
        LIMIT 1
    </select>

</mapper>



