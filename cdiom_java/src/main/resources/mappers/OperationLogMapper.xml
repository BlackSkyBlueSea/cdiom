<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cdiom.backend.mapper.OperationLogMapper">

    <!-- 操作日志统计 -->
    <select id="selectOperationStatistics" resultType="map">
        SELECT
            DATE_FORMAT(operation_time, '%Y-%m-%d') as date,
            operation_module,
            operation_type,
            COUNT(*) as operation_count,
            COUNT(CASE WHEN status = 1 THEN 1 END) as success_count,
            COUNT(CASE WHEN status = 0 THEN 1 END) as fail_count,
            AVG(execution_time) as avg_execution_time
        FROM operation_log
        WHERE operation_time >= #{startDate} AND operation_time <= #{endDate}
        GROUP BY DATE_FORMAT(operation_time, '%Y-%m-%d'), operation_module, operation_type
        ORDER BY date DESC, operation_count DESC
    </select>

    <!-- 用户操作统计 -->
    <select id="selectUserOperationStatistics" resultType="map">
        SELECT
            operator_id,
            operator_name,
            COUNT(*) as total_operations,
            COUNT(CASE WHEN status = 1 THEN 1 END) as success_operations,
            COUNT(CASE WHEN status = 0 THEN 1 END) as fail_operations,
            AVG(execution_time) as avg_execution_time,
            MAX(operation_time) as last_operation_time
        FROM operation_log
        WHERE operation_time >= #{startDate} AND operation_time <= #{endDate}
        GROUP BY operator_id, operator_name
        ORDER BY total_operations DESC
    </select>

    <!-- 模块操作统计 -->
    <select id="selectModuleStatistics" resultType="map">
        SELECT
            operation_module,
            COUNT(*) as total_operations,
            COUNT(DISTINCT operator_id) as unique_users,
            COUNT(CASE WHEN status = 1 THEN 1 END) as success_count,
            COUNT(CASE WHEN status = 0 THEN 1 END) as fail_count,
            AVG(execution_time) as avg_execution_time
        FROM operation_log
        WHERE operation_time >= #{startDate} AND operation_time <= #{endDate}
        GROUP BY operation_module
        ORDER BY total_operations DESC
    </select>

    <!-- 清理过期日志 -->
    <delete id="deleteExpiredLogs">
        DELETE FROM operation_log
        WHERE operation_time < #{beforeDate}
        AND operation_module NOT IN ('AUTH', 'SYSTEM')  <!-- 保留重要日志 -->
    </delete>

    <!-- 批量插入操作日志（用于批量操作记录） -->
    <insert id="batchInsert">
        INSERT INTO operation_log (
            operator_id, operator_name, operation_type, operation_module,
            operation_description, operation_time, ip_address, user_agent,
            request_url, request_method, request_params, response_result,
            execution_time, status, error_message, create_time
        ) VALUES
        <foreach item="log" collection="logs" separator=",">
            (
                #{log.operatorId}, #{log.operatorName}, #{log.operationType}, #{log.operationModule},
                #{log.operationDescription}, #{log.operationTime}, #{log.ipAddress}, #{log.userAgent},
                #{log.requestUrl}, #{log.requestMethod}, #{log.requestParams}, #{log.responseResult},
                #{log.executionTime}, #{log.status}, #{log.errorMessage}, #{log.createTime}
            )
        </foreach>
    </insert>

</mapper>